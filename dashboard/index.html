<!DOCTYPE html>
<html>
<head>
    <title>Contactical Real-time Trust Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 100vh; width: 100%; }
        .info-panel {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2); font-family: sans-serif;
            min-width: 200px;
        }
        .emergency { animation: pulse 1s infinite; }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>

<div id="map"></div>
<div class="info-panel">
    <h3>ğŸ“¡ Contactical Control Center</h3>
    <p id="stats">ë°ì´í„° ë¡œë”© ì¤‘...</p>
    <hr>
    <div style="font-size: 0.8em; color: #666;">
        â— ì´ˆë¡: ê³ ì‹ ë¢°(70+) | â— ì£¼í™©: ì¼ë°˜(30+) | â— ë¹¨ê°•: ì €ì‹ ë¢°
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
    // 1. ì§€ë„ ì´ˆê¸°í™” (ì„œìš¸ ì¤‘ì‹¬)
    var map = L.map('map').setView([37.5665, 126.9780], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // 2. íˆíŠ¸ë§µ ë ˆì´ì–´ ì´ˆê¸°í™”
    var heatLayer = L.heatLayer([], {
        radius: 30,
        blur: 15,
        maxZoom: 17
    }).addTo(map);

    var markersLayer = L.layerGroup().addTo(map);

    function getColor(score) {
        return score >= 70 ? '#2ecc71' :
               score >= 30 ? '#f39c12' : '#e74c3c';
    }

    async function updateMap() {
        try {
            // Python API í˜¸ì¶œ
            const response = await fetch('http://localhost:8000/claims');
            if (!response.ok) throw new Error('API ì„œë²„ ì‘ë‹µ ì—†ìŒ');
            
            const data = await response.json();

            // íˆíŠ¸ë§µ ì—…ë°ì´íŠ¸
            const heatData = data.features.map(f => [
                f.geometry.coordinates[1],
                f.geometry.coordinates[0],
                (f.properties.score / 100) + 0.2 // ê°€ì‹œì„±ì„ ìœ„í•´ ìµœì†Œ ê°•ë„ ë¶€ì—¬
            ]);
            heatLayer.setLatLngs(heatData);

            // ë§ˆì»¤ ì—…ë°ì´íŠ¸
            markersLayer.clearLayers();
            let emergencyCount = 0;

            data.features.forEach(feature => {
                const props = feature.properties;
                const coords = feature.geometry.coordinates;

                const marker = L.circleMarker([coords[1], coords[0]], {
                    radius: 12,
                    fillColor: getColor(props.score),
                    color: "#fff",
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8,
                    className: props.is_emergency ? 'emergency' : ''
                });

                if (props.is_emergency) emergencyCount++;

                const popupContent = `
                    <b>ğŸ›¡ï¸ Verified Node</b><br>
                    <small>${props.creator.substring(0, 15)}...</small><hr>
                    <b>ì‹ ë¢° ì ìˆ˜:</b> ${props.score}ì <br>
                    <b>ë³´ìƒ í•©ê³„:</b> ${props.reward.toLocaleString()} stake<br>
                    ${props.is_emergency ? '<b style="color:red;">ğŸš¨ EMERGENCY DATA</b>' : ''}
                `;

                marker.bindPopup(popupContent).addTo(markersLayer);
            });

            document.getElementById('stats').innerHTML = 
                `ì—°ê²°ëœ ì •ì§í•œ ë…¸ë“œ: ${data.features.length}ê°œ<br>` +
                `<span style="color:red">ê¸´ê¸‰ ìƒí™© ë°œìƒ: ${emergencyCount}ê±´</span>`;

        } catch (error) {
            console.error('Error fetching data:', error);
            document.getElementById('stats').innerText = "API ì„œë²„ ì—°ê²° ì‹¤íŒ¨ (8000 í¬íŠ¸ í™•ì¸)";
        }
    }

    // ì‹¤í–‰
    updateMap();
    setInterval(updateMap, 5000);
</script>
</body>
</html>